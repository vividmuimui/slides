<section>

<h2>2段階認証</h2>

<p><a href="https://github.com/vividmuimui" class="user-mention">@vividmuimui</a><br>
2017/08 社内LT資料</p>

</section>
<section>

<h2>話すこと</h2>

<ul>
  <li>2段階認証の概要</li>
  <li>仕様決める段階で考えること</li>
  <li>rubyで実装する時</li>
</ul>

</section>
<section>

<h2>2段階認証とは</h2>

<p>雑にいうと、<br>
ID/PWなどでログインした後に、それ以外の情報で認証をすること</p>

</section>
<section>

<h2>用語</h2>

<p>そもそも、</p>
<ul>
  <li>2<code>要素</code>認証(多要素認証)</li>
  <li>2<code>段階</code>認証(多段階認証)</li>
</ul>

<p>は別<br>
利用者から見たときはどっちでもいい話(よくないが)なので、「<code>2段階認証</code>」と書かれることが多い(気がする)<br>
ので、ここでは「<code>2段階認証</code>」と呼ぶことにします</p>

</section>
<section>

<h2>2段階認証の要素</h2>

<ul>
  <li>記憶情報
    <ul>
      <li>SYK: Something You Know</li>
      <li>ユーザーしか知らない情報
        <ul>
          <li>ID/PW/誕生日/秘密の質問など</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>所持情報
    <ul>
      <li>SYH: Something You Have</li>
      <li>ユーザーしか持っていない情報
        <ul>
          <li>携帯電話・ICカード・トークンデバイスなどを利用したもの</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>生体情報
    <ul>
      <li>SYA: Something You Are</li>
      <li>ユーザーの生体情報
        <ul>
          <li>指紋・虹彩など</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<p>これらの要素があり、2つ(以上)の要素を組み合わせて認証するので、2要素認証(多要素認証)という</p>

</section>
<section>

<p>2段階目の認証としてよくあるのが(僕目線)</p>

<ul>
  <li>SMSでワンタイムパスワードを送る</li>
  <li>「Google認証システム」アプリなどをつかった時間ベースのワンタイムパスワード
    <ul>
      <li>30秒で切り替わるやつ</li>
    </ul>
  </li>
  <li>専用アプリにpush通知-&gt;承認ボタンを押す
    <ul>
      <li>呼び方よくわからない。googleは「Google からのメッセージ」</li>
      <li>push通知でやってるのかもよく知らない</li>
      <li>twitterとか</li>
      <li>最近この方式がよく使われるようになっている印象</li>
    </ul>
  </li>
  <li>yubikeyなどのデバイストークン(?)</li>
  <li>専用IDやパスワードを郵送
    <ul>
      <li>お役所系のサイトに多い印象</li>
    </ul>
  </li>
</ul>

</section>
<section>

<h2>仕様決める段階で考えること</h2>

<ul>
  <li>どの方式を選択するか？いくつ用意するか？</li>
  <li>リカバリーコードの方針</li>
  <li>2段階認証はいつだすのか？</li>
  <li>2段階認証が突破できない時どうするのか？</li>
</ul>

</section>
<section>

<h3 class="left">どの方式を選択するか？いくつ用意するか？ <img class="emoji" alt=":one:" src="https://assets-cdn.github.com/images/icons/emoji/unicode/0031-20e3.png">
</h3>

<p>とりあえずやるのなら</p>
<ul>
  <li>「Google認証システム」アプリなどをつかった時間ベースのワンタイムパスワード</li>
</ul>

<p>一択だと思う</p>

<ul>
  <li>十分一般的</li>
  <li>実装が楽。ウェブエンジニアの作業だけで済む</li>
</ul>

</section>
<section>

<h3 class="left">どの方式を選択するか？いくつ用意するか？ <img class="emoji" alt=":two:" src="https://assets-cdn.github.com/images/icons/emoji/unicode/0032-20e3.png">
</h3>

<p>電話番号を扱うノウハウが有るのなら</p>
<ul>
  <li>SMSでワンタイムパスワード</li>
</ul>

<p>は選択肢の1つ<br>
電話番号をもっていると、問い合わせなどのほかの用途にも使えて便利そう。(端末やメールに比べて、電話番号は変わりにくいと思うので、何かと役立つ)</p>

<p>これ単体ではなく、ほかの方式と併用するのが良い<br>
また、ここらへんは読んでおく必要がある</p>

<ul>
  <li><a href="http://jp.techcrunch.com/2016/07/26/20160725nist-declares-the-age-of-sms-based-2-factor-authentication-over/">SMSを使った二要素認証を非推奨〜禁止へ、米国立技術規格研究所NISTの新ガイダンス案</a></li>
  <li><a href="http://ken5scal.hatenablog.com/entry/2017/07/31/SMS%E3%81%AB%E3%82%88%E3%82%8B2%E8%A6%81%E7%B4%A0%E8%AA%8D%E8%A8%BC%E3%81%AF%E6%9C%AC%E5%BD%93%E3%81%AB%E9%9D%9E%E6%8E%A8%E5%A5%A8%E3%81%AA%E3%81%AE%E3%81%8B%EF%BC%9F">SMSによる2要素認証は本当に非推奨なのか？</a></li>
</ul>

</section>
<section>

<h3 class="left">どの方式を選択するか？いくつ用意するか？ <img class="emoji" alt=":three:" src="https://assets-cdn.github.com/images/icons/emoji/unicode/0033-20e3.png">
</h3>

<p>何かしらの専用スマホアプリがあるのなら</p>
<ul>
  <li>専用アプリにpush通知-&gt;承認ボタンを押す</li>
</ul>

<p>がオススメ<br>
数字を入力するなどの必要が無いので、ユーザーの手間が少ない<br>
ナウい <img class="emoji" alt=":sunglasses:" src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f60e.png"></p>

<p>これは単体では使えず、ほかの方式と併用する必要がある<br>
(おそらく。そのアプリに初めてログインするときの2段階認証は？となるので)</p>

</section>
<section>

<h2>Google</h2>

<p>(2017/08/02 現時点の話)<br>
googleは、2段階認証を初めて設定する際は、<br>
電話番号(SMS or 音声)を利用した方式を設定する必要がある</p>

<p>それ以降は、<br>
「Google認証システム」や「Google からのメッセージ」などいくつかの種類の方式から、<br>
好きなものを設定できる</p>

</section>
<section>

<h2>リカバリーコードの方針</h2>

<p>これら検討する必要がある</p>

<ul>
  <li>使い捨てか
    <ul>
      <li>使い捨てしか見たこと無い</li>
    </ul>
  </li>
  <li>いくつ用意するのか？
    <ul>
      <li>1 or 10あたり</li>
    </ul>
  </li>
</ul>

<p>などなど検討することはあるが、重要なのは↓</p>

<ul>
  <li>ユーザーが現在有効なリカバリーコードを確認出来る必要があるか？
    <ul>
      <li>リカバリーコードをDBに保存する際に、ハッシュ化するのか暗号化するのか</li>
      <li>ログインのパスワードと重要度は変わらないし、ハッシュ化するのが望ましそう(要件によるが)</li>
      <li>ハッシュ化の場合は、リカバリーコードを確認したいようなケースの際は常に再発行することになる</li>
    </ul>
  </li>
</ul>

</section>
<section>

<h2>2段階認証はいつ出すのか？</h2>

<p>基本方針は、「ユーザーを認証するタイミングで出す」<br>
なので、通常のログイン以外にも、パスワード再発行とき等にも出す必要はありそう</p>

<ul>
  <li>ワンタイムパスワードをメールで送信</li>
  <li>入力画面で、ID/ワンタイムパスワードを入力</li>
  <li>2段階認証</li>
  <li>新しいパスワード設定画面</li>
</ul>

<p>という流れ<br>
だが、実装によるし、本当に出す必要があるか、は議論の余地がある <img class="emoji" alt=":confused:" src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f615.png"></p>

</section>
<section>

<ul>
  <li>ユーザーが「受け取ったメール」、は本当に本人しか受け取れないものか？<code>所持情報</code>？</li>
  <li>そもそも、メール以外で本人しか受け取れないルートはないか？
    <ul>
      <li>専用アプリの2段階認証ができてるのであれば、その専用アプリにワンタイムパスワード送るとかでも良さそう
        <ul>
          <li>(たぶん)</li>
        </ul>
      </li>
      <li>Google認証システムでの2段階認証が登録されてれば、それをワンタイムパスワードとして「入力画面で、ID/ワンタイムパスワードを入力」に入力してもらう</li>
    </ul>
  </li>
  <li>ほかの方法でユーザーを認証できないか
    <ul>
      <li>秘密の質問・一つ前のパスワード・アカウント年月・電話番号などいくつかの質問を重ねていって本人と確認する
        <ul>
          <li>Googleがこの方式(詳しくは見てない)</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<p>とかとか</p>

<p>素直に「ワンタイムパスワードをメールで送信」で実装するのなら、安全に倒して2段階認証出しておくのが良いと思う<br>
ユーザーの手間が増えるが、パスワードの再発行とかは頻繁に行われないので問題ない</p>

</section>
<section>

<h2>2段階認証が突破できない時どうするのか？</h2>

<ul>
  <li>「信用できる端末(この端末からは2段階認証をこれ以降要求しない)」の設定がされた端末があればそれでログインしてもらう</li>
  <li>
    <p>SMSを送れるのであればそれ経由でワンタイムパスワード</p>
  </li>
  <li>2段階認証のいずれでもダメ、リカバリーコードも控えてない<img class="emoji" alt=":scream:" src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f631.png">
    <ul>
      <li>ユーザーサポートに問い合わせをしてもらうしか無い。</li>
      <li>本人確認をし、新しいリカバリーコードを渡す、新しい携帯にワンタイムパスワードを送るなどする</li>
      <li>
<img class="emoji" alt=":warning:" src="https://assets-cdn.github.com/images/icons/emoji/unicode/26a0.png"> 2段階認証の設定を強制的にOFFにしてから、ユーザーにログインさせるのは良くない
        <ul>
          <li>アカウント乗っ取りの可能性が増える</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

</section>
<section>

<h2>rubyで実装する時 <img class="emoji" alt=":gem:" src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f48e.png">
</h2>

<p>「Google認証システムなどをつかった時間ベースのワンタイムパスワード」この方式を実装する時の話</p>

<ul>
  <li>deviseを使っているのなら
    <ul>
      <li>
<a href="https://rubygems.org/gems/devise-two-factor">devise-two-factor</a>をつかうのが手っ取り早くて良さそう</li>
      <li>試してない</li>
    </ul>
  </li>
  <li>devise以外なら
    <ul>
      <li>
<a href="https://rubygems.org/gems/rotp">rotp</a>をつかうのが良い</li>
      <li>(+ QRコードを表示するためのgem)</li>
    </ul>
  </li>
</ul>

</section>
<section>

<h3 class="left">Gemの選択基準/実装時に気をつけること</h3>

<ul>
  <li>ユーザーごとにsecret keyを生成・保存する必要があるが、適切に保存されているか？
    <ul>
      <li>暗号化されておくのが望ましい</li>
    </ul>
  </li>
  <li>一度認証を通したコード(ワンタイムパスワード)は、使えないようにできるか？
    <ul>
      <li>対策しないと、その30秒の間は何度も同じコードで認証できる</li>
      <li>=&gt; 悪意あるユーザーが認証を突破できてしまう可能性が増える</li>
      <li>rotpでは<code>#verify_with_drift_and_prior</code>で対策できる。
        <ul>
          <li>
<a href="https://github.com/mdp/rotp#preventing-reuse-of-time-based-otps">README</a>にやり方書いてある</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

</section>
<section>

<h2>おわり</h2>

<p>「Google認証システムなどをつかった時間ベースのワンタイムパスワード」で実装するのは、<br>
要件・仕様さえ決まればサクッとできる</p>

</section>
<section>

<h2>おまけ</h2>

<p><a href="https://rubygems.org/gems/recaptcha">reCAPTCHA</a>の組み込みはもっと楽だった</p>

</section>
<section>

<h2>おまけ <img class="emoji" alt=":two:" src="https://assets-cdn.github.com/images/icons/emoji/unicode/0032-20e3.png">
</h2>

<p>「2段階認証(2要素認証)」を英語にすると、<br>
「two factor authentication」だが、</p>
<ul>
  <li>実装する上で two_factor_authentication は
    <ul>
      <li>長い</li>
      <li>typoしやすい</li>
    </ul>
  </li>
  <li>2faと略そうとしても、数字から始まるメソッド名はつけれない(ruby)</li>
  <li>otp(one time password)と略すのはちょっと違う
    <ul>
      <li>otpはotpなので</li>
    </ul>
  </li>
</ul>

<p>良い落とし所が見つからない。。<br>
<img class="emoji" alt=":cry:" src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f622.png"></p>

</section>
